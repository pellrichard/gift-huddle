EOD: FX rates infra, Edit Profile currency integration, and ESLint flat-config migration

Summary

Integrated live FX updates into the Edit Profile flow and added a fallback path to make the call resilient during beta.

Introduced a snapshot table (currency_rates) and updated the Edge Function to both log (fx_rates) and upsert latest rates into the snapshot table.

Migrated ESLint to flat config (with Next.js + TS support) and cleaned up repo lint/type issues.

Fixed UI/logic in EditProfileModal (button variants, error visibility, and hook ordering/parse issues).

What changed

Frontend

src/components/account/EditProfileModal.tsx

FX updater on modal open (dev/beta gated by NEXT_PUBLIC_ENABLE_FX_AUTOUPDATE).

Headers hardened for Supabase Edge (Authorization: Bearer <anon>, apikey).

Resilient fallback: if supabase.functions.invoke('fx_updater') fails (CORS/headers), we directly fetch ${NEXT_PUBLIC_SUPABASE_URL}/functions/v1/fx_updater.

Inline error banner (fxError) so failures are obvious in the UI.

Currency dropdown now prefers currency_rates (snapshot), falls back to legacy fx_rates scan if snapshot is empty.

Fixed prior parsing/lint issues (duplicate });, conditional hooks, unused vars).

Edge Function

supabase/functions/fx_updater/index.ts

CORS improved: echoes Origin and requested headers so preflight succeeds (covers x-client-info, etc.).

Logs the fetched rates to fx_rates.

Upserts the latest base/rates into currency_rates (idempotent by code).

Returns { ok, base, effective_date, updated_count } for observability.

Database

supabase/migrations/20251005_currency_rates.sql

Creates public.currency_rates:

code (PK), name, rate, base, updated_at

Index on updated_at.

RLS enabled; read-all policy; explicit service-role write policy.

(Note) fx_rates remains the log, not the source of truth for dropdowns.

Tooling / Build

eslint.config.mjs (flat config):

Ignores supabase/functions/\*\* (Deno).

Adds TypeScript + Next.js (core-web-vitals) rules.

Declares browser + node globals to avoid no-undef on window, URL, process, Response, etc.

package.json (devDeps):

@next/eslint-plugin-next, @eslint/js, typescript-eslint, globals.

Removed: .eslintignore, eslint.config.js.

tsconfig.json:

exclude: \["supabase/\*\*"] so Next/TS doesn’t attempt to typecheck Deno imports.

Why

During beta, we want fresh FX without manual triggers and a robust call path that works even if the Edge preflight is picky.

Keeping logs (fx_rates) is useful for audit/troubleshooting; reading snapshot (currency_rates) is fast and stable for UI.

Flat ESLint config removes legacy warnings and gives us consistent TS/JSX linting in Next 15.

How to test

Environment

NEXT_PUBLIC_SUPABASE_URL = https://<project-ref>.supabase.co

NEXT_PUBLIC_SUPABASE_ANON_KEY = <anon-key>

NEXT_PUBLIC_ENABLE_FX_AUTOUPDATE = 1 (for dev/beta only)

Database

Run the migration (Studio → SQL) to create currency_rates.

Confirm RLS policies exist.

Edge Function

Deploy fx_updater (Studio editor or CLI).

Set secrets: SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY.

App

Build and run locally or on Vercel.

Open Edit Profile:

DevTools → Network: see POST /functions/v1/fx_updater with Authorization and apikey.

If invoke path fails, a second request (fallback fetch) should appear.

Console: see \[fx_updater] result … (invoke) or \[fx_updater] fetch result … (fallback).

UI: if failure, a red banner appears in the modal (fxError).

Data

Supabase Studio:

currency_rates should have current rows (one per code).

fx_rates should log the payload with effective_date.

Deployment notes

DB: apply the migration.

Edge Function: deploy fx_updater and set required secrets.

Web: redeploy with the NEXT_PUBLIC\_\* envs in Vercel.

After verification in production, consider toggling NEXT_PUBLIC_ENABLE_FX_AUTOUPDATE to 0 to limit auto-calls.

Rollback

Frontend: revert EditProfileModal.tsx to previous version (removes fallback and auto-invoke).

Edge Function: revert to prior version if CORS causes issues.

DB: currency_rates is additive; safe to keep. UI can fallback to fx_rates scan.

Known / follow-ups

Next’s “plugin not detected” warning can persist with flat configs; functionally fine. Optional workaround: add a tiny .eslintrc.json with { "extends": \["next/core-web-vitals"] } purely to satisfy the detector.

Optional: add a success toast/pill (“FX updated just now”) after successful update.

Optional: schedule a nightly rates refresh (CRON on Edge) for production redundancy.

Checklist

&nbsp;currency_rates table available in prod

&nbsp;Edge fx_updater deployed with secrets

&nbsp;EditProfileModal autoupdate gated in non-prod or by env var

&nbsp;Lint/type errors resolved; build green

&nbsp;Manual verification: Network headers, Supabase Invocations, data persisted

Screenshots / Logs (attach when merging)

Network panel showing headers and 200 OK

Supabase → Edge Functions → Invocations

Table Editor: currency_rates rows populated
