EOD: FX rates infra, Edit Profile currency integration, and ESLint flat-config migration

Summary



Integrated live FX updates into the Edit Profile flow and added a fallback path to make the call resilient during beta.



Introduced a snapshot table (currency\_rates) and updated the Edge Function to both log (fx\_rates) and upsert latest rates into the snapshot table.



Migrated ESLint to flat config (with Next.js + TS support) and cleaned up repo lint/type issues.



Fixed UI/logic in EditProfileModal (button variants, error visibility, and hook ordering/parse issues).



What changed

Frontend



src/components/account/EditProfileModal.tsx



FX updater on modal open (dev/beta gated by NEXT\_PUBLIC\_ENABLE\_FX\_AUTOUPDATE).



Headers hardened for Supabase Edge (Authorization: Bearer <anon>, apikey).



Resilient fallback: if supabase.functions.invoke('fx\_updater') fails (CORS/headers), we directly fetch ${NEXT\_PUBLIC\_SUPABASE\_URL}/functions/v1/fx\_updater.



Inline error banner (fxError) so failures are obvious in the UI.



Currency dropdown now prefers currency\_rates (snapshot), falls back to legacy fx\_rates scan if snapshot is empty.



Fixed prior parsing/lint issues (duplicate });, conditional hooks, unused vars).



Edge Function



supabase/functions/fx\_updater/index.ts



CORS improved: echoes Origin and requested headers so preflight succeeds (covers x-client-info, etc.).



Logs the fetched rates to fx\_rates.



Upserts the latest base/rates into currency\_rates (idempotent by code).



Returns { ok, base, effective\_date, updated\_count } for observability.



Database



supabase/migrations/20251005\_currency\_rates.sql



Creates public.currency\_rates:



code (PK), name, rate, base, updated\_at



Index on updated\_at.



RLS enabled; read-all policy; explicit service-role write policy.



(Note) fx\_rates remains the log, not the source of truth for dropdowns.



Tooling / Build



eslint.config.mjs (flat config):



Ignores supabase/functions/\*\* (Deno).



Adds TypeScript + Next.js (core-web-vitals) rules.



Declares browser + node globals to avoid no-undef on window, URL, process, Response, etc.



package.json (devDeps):



@next/eslint-plugin-next, @eslint/js, typescript-eslint, globals.



Removed: .eslintignore, eslint.config.js.



tsconfig.json:



exclude: \["supabase/\*\*"] so Next/TS doesn’t attempt to typecheck Deno imports.



Why



During beta, we want fresh FX without manual triggers and a robust call path that works even if the Edge preflight is picky.



Keeping logs (fx\_rates) is useful for audit/troubleshooting; reading snapshot (currency\_rates) is fast and stable for UI.



Flat ESLint config removes legacy warnings and gives us consistent TS/JSX linting in Next 15.



How to test



Environment



NEXT\_PUBLIC\_SUPABASE\_URL = https://<project-ref>.supabase.co



NEXT\_PUBLIC\_SUPABASE\_ANON\_KEY = <anon-key>



NEXT\_PUBLIC\_ENABLE\_FX\_AUTOUPDATE = 1 (for dev/beta only)



Database



Run the migration (Studio → SQL) to create currency\_rates.



Confirm RLS policies exist.



Edge Function



Deploy fx\_updater (Studio editor or CLI).



Set secrets: SUPABASE\_URL, SUPABASE\_SERVICE\_ROLE\_KEY.



App



Build and run locally or on Vercel.



Open Edit Profile:



DevTools → Network: see POST /functions/v1/fx\_updater with Authorization and apikey.



If invoke path fails, a second request (fallback fetch) should appear.



Console: see \[fx\_updater] result … (invoke) or \[fx\_updater] fetch result … (fallback).



UI: if failure, a red banner appears in the modal (fxError).



Data



Supabase Studio:



currency\_rates should have current rows (one per code).



fx\_rates should log the payload with effective\_date.



Deployment notes



DB: apply the migration.



Edge Function: deploy fx\_updater and set required secrets.



Web: redeploy with the NEXT\_PUBLIC\_\* envs in Vercel.



After verification in production, consider toggling NEXT\_PUBLIC\_ENABLE\_FX\_AUTOUPDATE to 0 to limit auto-calls.



Rollback



Frontend: revert EditProfileModal.tsx to previous version (removes fallback and auto-invoke).



Edge Function: revert to prior version if CORS causes issues.



DB: currency\_rates is additive; safe to keep. UI can fallback to fx\_rates scan.



Known / follow-ups



Next’s “plugin not detected” warning can persist with flat configs; functionally fine. Optional workaround: add a tiny .eslintrc.json with { "extends": \["next/core-web-vitals"] } purely to satisfy the detector.



Optional: add a success toast/pill (“FX updated just now”) after successful update.



Optional: schedule a nightly rates refresh (CRON on Edge) for production redundancy.



Checklist



&nbsp;currency\_rates table available in prod



&nbsp;Edge fx\_updater deployed with secrets



&nbsp;EditProfileModal autoupdate gated in non-prod or by env var



&nbsp;Lint/type errors resolved; build green



&nbsp;Manual verification: Network headers, Supabase Invocations, data persisted



Screenshots / Logs (attach when merging)



Network panel showing headers and 200 OK



Supabase → Edge Functions → Invocations



Table Editor: currency\_rates rows populated

